<form
  id="send-search"
  class="flex flex-col w-full items-center gap-4"
  method="POST"
  hx-post="{% url 'send_search' %}"
  hx-target="#search-results"
  hx-swap="innerHTML"
>
  {% csrf_token %}
  <!-- Topic Selection -->
  <label class="form-control w-full">
    <label class="label label-text text-lg" for="topic">Topic</label>
    <select id="topic" name="topic" class="select select-primary" required>
      <option value="" disabled selected>Select one</option>
      {% for prompt in premade_prompts %}
      <option value="{{ prompt }}">{{ prompt }}</option>
      {% endfor %}
    </select>
  </label>

  <!-- Origin Selection (Hidden by Default)-->
  <div id="origin-container" class="w-full" style="display:none;">
    <label class="form-control w-full">
      <label class="label label-text text-lg">Origin</label>
      <select id="origin" name="origin" class="select select-primary">
        <option value="" disabled selected>Select One</option>
        {% for location in cities %}
        <option value="{{ location }}">{{ location }}</option>
        {% endfor %}
      </select>
    </label>
  </div>

  <!-- Flight Date Selection (Hidden by Default)-->
  <div id="flight-date-container" class="w-full" style="display:none;">
    <label class="form-control w-full">
      <label class="label label-text text-lg" for="flight-date">Flight Date</label>
      <input type="date" id="flight-date" name="flight-date" class="input input-primary">
    </label>
  </div>

  <button type="submit" id="search-btn" class="btn btn-secondary w-1/2">
    Search
  </button>
</form>

{% comment %} <p class="text-center mt-4 font-bold">
  Do you want to learn more about the city? (neighborhood security of an specific address, stays near gas stations) Go to the
  <a class="link" href="{% url 'chatbot' %}">chat page</a> for futher assistance
</p> {% endcomment %}

<div
  id="search-results"
  class="flex flex-col w-full min-h-full mt-4 overflow-y-scroll"
></div>

<script>
  function handleTopicChange() {
    const topic = document.querySelector("#topic").value;
    const origin = document.querySelector("#origin-container");
    const flight_date = document.querySelector("#flight-date-container");

    if (topic === "Flights") {
      origin.style.display = "block";
      flight_date.style.display = "block"
    } else {
      origin.style.display = "none";
      flight_date.style.display = "none";
    }
  }
  document.querySelector("#topic").addEventListener("change", handleTopicChange);

  function afterSendSearch() {
    const city = "{{ city }}";
    const reason = "{{ reason }}";
    const topic = document.querySelector("#topic").value;
    document.querySelector('#search-btn').disabled = true;
    let url = `/search_response/${city}/${reason}/${topic}/`;

    if (topic === "Flights") {
      const origin_elmt = document.querySelector("#origin");
      const flight_date_elmt = document.querySelector("#flight-date");

      const origin = origin_elmt ? origin_elmt.value : null;
      const flight_date = flight_date_elmt ? flight_date_elmt.value : null;
      if(origin) {
        url += `?origin=${encodeURIComponent(origin)}`;
      } 
      if (flight_date) {
        url += origin ? `&flight_date=${encodeURIComponent(flight_date)}` : `?flight_date=${encodeURIComponent(flight_date)}`;
      }
    }

    htmx.ajax("POST", url, {
      target: "#search-results",
      swap: "innerHTML",
      headers: {
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
      },
    });
  }

  document
    .querySelector("#send-search")
    .addEventListener("htmx:afterRequest", () => {
      afterSendSearch();
    });

    document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'search-results') {
      if (typeof reinitializeMap === "function") {
        try {
          reinitializeMap();
        } catch (error) {
          console.error("Error reinitializing map:", error);
        }
      }
      document.querySelector('#search-btn').disabled = false;
    }
  });
</script>