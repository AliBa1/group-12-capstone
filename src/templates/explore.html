{% extends 'layouts/mainpage.html' %} {% block content %}
<body>
  <div class="flex w-full" style="height: calc(100vh - 64px)">
    <ul
      class="menu bg-base-200 w-1/3 lg:w-1/6 flex-nowrap overflow-y-scroll overflow-x-hidden"
    >
      <label
        class="btn btn-xs sm:btn-sm md:btn-md lg:btn-lg md:text-sm self-center text-white bg-blue-500 hover:bg-blue-600"
        for="new-conversation"
      >
        New Conversation
      </label>
      <li class="menu-title">Conversations</li>
      {% for c in conversations %}
      <li class="list-none w-full">
        <div
          id="conversation"
          data-id="{{ c.id }}"
          class="flex items-center justify-between w-full h-12 px-0 cursor-pointer transition-colors"
          hx-get="{% url 'fetch_conversation' c.id %}"
          hx-target="#chat"
          hx-swap="innerHTML"
          hx-on:click="document.querySelectorAll('#conversation').forEach((cdiv) => cdiv.classList.remove('active')); this.classList.add('active');"
        >
          <a class="flex items-center h-full px-2 truncate"> {{ c.title }} </a>

          <div class="dropdown dropdown-bottom dropdown-end">
            <div
              tabindex="0"
              role="button"
              class="btn bg-transparent border-none"
              onclick="event.stopPropagation()"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                class="inline-block h-5 w-5 stroke-current"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"
                ></path>
              </svg>
            </div>
            <ul
              tabindex="0"
              class="dropdown-content menu bg-base-100 rounded-box z-[1] p-2 shadow overflow-visible"
            >
              <li>
                <a
                  class="px-4"
                  href="#"
                  onclick="openEditModal({{ c.id }}, '{{ c.title|escapejs }}', '{{ c.city|escapejs }}', '{{ c.reason|escapejs }}')"
                  >Edit</a
                >
              </li>
              <li>
                <a
                  class="text-red-500 px-4"
                  href="#"
                  onclick="openDeleteModal({{ c.id }}, '{{ c.title|escapejs }}')"
                  >Delete</a
                >
              </li>
            </ul>
          </div>
        </div>
      </li>

      {% endfor %}
    </ul>

    <div class="w-2/3 lg:w-5/6 bg-gray-600 flex flex-col items-center py-4">
      <div id="no-active" class="px-2 text-white font-bold text-xl">
        Select a conversation to begin
      </div>

      <div
        id="chat"
        class="w-full md:w-1/2 px-2 md:px-0 flex flex-col h-full justify-end"
        hx-on::after-swap="document.querySelector('#no-active').classList.add('hidden')"
      ></div>
    </div>
  </div>

  <div id="messages-container">
    {% comment %} {% if messages %}
    <div>
      {% for message in messages %}
      <p>{{ message }}</p>
      {% endfor %}
    </div>
    {% endif %} {% endcomment %}
  </div>

  <input type="checkbox" id="new-conversation" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box">
      <h3 class="text-lg font-bold pb-4">Start a New Conversation</h3>
      <form
        id="new-conversation-form"
        method="POST"
        action="{% url 'new_conversation' %}"
        hx-target="#messages-container"
      >
        {% csrf_token %}
        <div class="form-control">
          <label for="conversation-title">Title</label>
          <input
            type="text"
            id="conversation-title"
            name="title"
            class="input input-bordered"
            required
          />
        </div>

        <label class="form-control mt-2">
          <label class="label label-text" for="city">City</label>
          <select id="city" name="city" class="select select-bordered" required>
            <option value="" disabled selected>Pick one</option>
            {% for city in cities %}
            <option value="{{ city }}">{{ city }}</option>
            {% endfor %}
          </select>
        </label>

        <label class="form-control mt-2">
          <label class="label label-text" for="reason">Reason</label>
          <select
            id="reason"
            name="reason"
            class="select select-bordered"
            required
          >
            <option value="" disabled selected>Pick one</option>
            <option value="Travel">Travel</option>
            <option value="Moving">Moving</option>
          </select>
        </label>

        <div class="modal-action">
          <label
            for="new-conversation"
            class="btn text-white bg-red-500 hover:bg-red-600"
            >Cancel</label
          >
          <button
            type="submit"
            class="btn text-white bg-green-500 hover:bg-green-600"
          >
            Create
          </button>
        </div>
      </form>
    </div>
  </div>

  <input type="checkbox" id="edit-conversation" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box">
      <h3 class="text-lg font-bold pb-4">Edit Your Conversation</h3>
      <form
        id="edit-conversation-form"
        method="POST"
        action=""
        hx-target="#messages-container"
      >
        {% csrf_token %}
        <div class="form-control">
          <label for="updated-title">Title</label>
          <input
            type="text"
            id="updated-title"
            name="updated-title"
            class="input input-bordered"
            required
          />
        </div>

        <label class="form-control mt-2">
          <label class="label label-text" for="updated-city">City</label>
          <select
            id="updated-city"
            name="updated-city"
            class="select select-bordered"
            required
          >
            <option value="" disabled selected>Pick one</option>
            {% for city in cities %}
            <option value="{{ city }}">{{ city }}</option>
            {% endfor %}
          </select>
        </label>

        <label class="form-control mt-2">
          <label class="label label-text" for="updated-reason">Reason</label>
          <select
            id="updated-reason"
            name="updated-reason"
            class="select select-bordered"
            required
          >
            <option value="" disabled selected>Pick one</option>
            <option value="Travel">Travel</option>
            <option value="Moving">Moving</option>
          </select>
        </label>

        <div class="modal-action">
          <label
            for="edit-conversation"
            class="btn text-white bg-red-500 hover:bg-red-600"
            >Cancel</label
          >
          <button
            type="submit"
            class="btn text-white bg-blue-500 hover:bg-blue-600"
          >
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <input type="checkbox" id="delete-conversation" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box">
      <h3
        id="delete-conversation-title"
        class="text-lg font-bold pb-4 truncate"
      >
        Delete Conversation?
      </h3>
      <form
        id="delete-conversation-form"
        method="POST"
        action=""
        hx-target="#messages-container"
      >
        {% csrf_token %}
        <p for="conversation-delete">
          The conversation and all messages associated with it will be
          permanatly deleted
        </p>
        <div class="modal-action">
          <label for="delete-conversation" class="btn text-white">Cancel</label>
          <button
            type="submit"
            class="btn text-white bg-red-500 hover:bg-red-600"
          >
            Delete
          </button>
        </div>
      </form>
    </div>
  </div>
</body>
<script>
  // hx-on::before-on-load="console.log('hrhr'); if (new_c_id != null) {document.querySelectorAll('#conversation').forEach((cdiv) => cdiv.classList.remove('active')); document.querySelector('[data-id=new_c_id]').classList.add('active');}"
  function openEditModal(
    conversationId,
    currentTitle,
    currentCity,
    currentReason
  ) {
    document.querySelector(
      "#edit-conversation-form"
    ).action = `/edit_conversation/${conversationId}/`;
    document.querySelector("#updated-title").value = currentTitle;
    document.querySelector("#updated-city").value = currentCity;
    document.querySelector("#updated-reason").value = currentReason;
    // document.querySelector("#updated-title").focus();
    document.querySelector("#edit-conversation").checked = true;
  }

  function openDeleteModal(conversationId, conversationTitle) {
    document.querySelector(
      "#delete-conversation-form"
    ).action = `/delete_conversation/${conversationId}/`;
    document.querySelector(
      "#delete-conversation-title"
    ).innerText = `Delete Conversation: ${conversationTitle}`;
    document.querySelector("#delete-conversation").checked = true;
  }
</script>
{%endblock%}
